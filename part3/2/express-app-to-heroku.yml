name: Deploy to Heroku

on:
  workflow_run:
    workflows:
      - "Publish image to Docker Hub"
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Store Heroku API key in .netrc
        run: |
          echo -e "machine api.heroku.com\n  login ${{ secrets.HEROKU_EMAIL }}\n  password ${{ secrets.HEROKU_API_KEY }}" >> $HOME/.netrc
          echo -e "machine git.heroku.com\n  login ${{ secrets.HEROKU_EMAIL }}\n  password ${{ secrets.HEROKU_API_KEY }}" >> $HOME/.netrc
          chmod 600 $HOME/.netrc

      - name: Login to Heroku
        run: heroku login

      - name: Push Docker image to Heroku
        run: |
          docker pull servufi/mooc-express-app:latest
          docker tag servufi/mooc-express-app:latest registry.heroku.com/mooc-express-app/web
          docker push registry.heroku.com/mooc-express-app/web

      - name: Release to Heroku
        run: heroku container:release web -a mooc-express-app